"use strict";var _marks,_nodes;Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _classnames=_interopRequireDefault(require("classnames")),_immer=_interopRequireDefault(require("immer")),_propTypes=_interopRequireDefault(require("prop-types")),_react=_interopRequireWildcard(require("react")),_slateReact=require("slate-react"),_slate=require("slate"),_marks2=require("./marks"),_toggleMarks=_interopRequireDefault(require("./toggle-marks")),_renderMarks=_interopRequireDefault(require("./render-marks")),_sendMessage=_interopRequireDefault(require("./send-message")),_markdown=_interopRequireDefault(require("../../plugins/markdown")),_mentions=_interopRequireDefault(require("../../plugins/mentions"));require("./styles.scss");function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var a=new WeakMap;return _getRequireWildcardCache=function(){return a},a}function _interopRequireWildcard(a){if(a&&a.__esModule)return a;var b=_getRequireWildcardCache();if(b&&b.has(a))return b.get(a);var c={};if(null!=a){var d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in a)if(Object.prototype.hasOwnProperty.call(a,e)){var f=d?Object.getOwnPropertyDescriptor(a,e):null;f&&(f.get||f.set)?Object.defineProperty(c,e,f):c[e]=a[e]}}return c["default"]=a,b&&b.set(a,c),c}function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var _Mentions=(0,_mentions["default"])(),markMention=_Mentions.markMention,MentionsPlugin=_Mentions.Plugin,STYLE={BOLD:"bold",ITALIC:"italic",UNDERLINE:"underline",CODE:"code",H1:"h1",H2:"h2",H3:"h3",NORMAL:"paragraph"},InitialValue=_slate.Value.fromJSON({document:{nodes:[{object:"block",type:"paragraph",nodes:[{object:"text",leaves:[{text:""}]}]}]}}),plugins=[(0,_toggleMarks["default"])({b:STYLE.BOLD,i:STYLE.ITALIC,u:STYLE.UNDERLINE}),(0,_renderMarks["default"])({marks:(_marks={},_defineProperty(_marks,STYLE.BOLD,_marks2.Bold),_defineProperty(_marks,STYLE.ITALIC,_marks2.Italic),_defineProperty(_marks,STYLE.UNDERLINE,_marks2.Underline),_defineProperty(_marks,STYLE.CODE,_marks2.Code),_marks),nodes:(_nodes={},_defineProperty(_nodes,STYLE.H1,_marks2.H1),_defineProperty(_nodes,STYLE.H2,_marks2.H2),_defineProperty(_nodes,STYLE.H3,_marks2.H3),_nodes)}),(0,_markdown["default"])(),MentionsPlugin(),(0,_sendMessage["default"])(InitialValue)],Composer=function(a){var b=a.emitter,c=a.active,d=a.markdown,e=a.mentions,f=a.send,g=a.disabled,h=a.draft,i=a.notifyKeyDown,j=a.placeholder,k=(0,_react.useRef)(null),l=function(){return k.current.focus()},m=function(a){return k.current.insertText(a)},n=function(a){k.current.toggleMark(a)},o=function(a){var b=k.current.value.blocks.some(function(b){return b.type==a});k.current.setBlocks(b?"paragraph":a)};(0,_react.useEffect)(function(){return b.on("toggleBold",function(){return n(STYLE.BOLD)}),b.on("toggleItalic",function(){return n(STYLE.ITALIC)}),b.on("toggleUnderline",function(){return n(STYLE.UNDERLINE)}),b.on("toggleCode",function(){return n(STYLE.CODE)}),b.on("toggleNormal",function(){return o(STYLE.NORMAL)}),b.on("toggleH1",function(){return o(STYLE.H1)}),b.on("toggleH2",function(){return o(STYLE.H2)}),b.on("toggleH3",function(){return o(STYLE.H3)}),b.on("FOCUS",l),b.on("INSERT_TEXT",m),b.on("SEND",function(){return k.current.sendMessage()}),function(){b.off("toggleBold"),b.off("toggleItalic"),b.off("toggleUnderline"),b.off("toggleCode"),b.off("toggleNormal"),b.off("toggleH1"),b.off("toggleH2"),b.off("toggleH3"),b.off("FOCUS",l),b.off("INSERT_TEXT",m),b.off("SEND")}},[b]);var p=(0,_react.useRef)({}),q=function(a){c&&(p.current=(0,_immer["default"])(p.current,function(b){b.bold=a.activeMarks.some(function(a){return a.type===STYLE.BOLD}),b.italic=a.activeMarks.some(function(a){return a.type===STYLE.ITALIC}),b.underline=a.activeMarks.some(function(a){return a.type===STYLE.UNDERLINE}),b.code=a.activeMarks.some(function(a){return a.type===STYLE.CODE}),b.normal=a.blocks.some(function(a){return"paragraph"===a.type}),b.h1=a.blocks.some(function(a){return"h1"===a.type}),b.h2=a.blocks.some(function(a){return"h2"===a.type}),b.h3=a.blocks.some(function(a){return"h3"===a.type})}),c(p.current))},r=(0,_react.useState)(InitialValue),s=_slicedToArray(r,2),t=s[0],u=s[1],v=function(a){var b=a.value;q(b),u(b)};(0,_react.useEffect)(function(){h.value?v({value:h.value}):v({value:InitialValue})},[h.id]),(0,_react.useEffect)(function(){h.save&&h.save(t,h.id)},[t]),(0,_react.useEffect)(function(){var a=markMention(k.current);a&&v({value:a})}),(0,_react.useEffect)(function(){setTimeout(function(){return k.current.insertText("a").deleteBackward(1)})},[j]);var w=(0,_classnames["default"])("draft-root",{disabled:g});return _react["default"].createElement("div",{className:w,onClick:l,onKeyPress:l,role:"textbox",tabIndex:-1},_react["default"].createElement(_slateReact.Editor,{className:"composer-editable",value:t,notifyKeyDown:i,onChange:v,placeholder:j,plugins:plugins,readOnly:g,ref:k,send:f,markdown:d,mentions:e}))};Composer.propTypes={disabled:_propTypes["default"].bool,draft:_propTypes["default"].shape({id:_propTypes["default"].any,value:_propTypes["default"].object,save:_propTypes["default"].func}),markdown:_propTypes["default"].shape({disabled:_propTypes["default"].bool}),notifyKeyDown:_propTypes["default"].func,placeholder:_propTypes["default"].string},Composer.defaultProps={disabled:!1,draft:{},markdown:{disabled:!1},notifyKeyDown:null,placeholder:""};var _default=_react["default"].memo(Composer);exports["default"]=_default;