"use strict";var _prismjs=_interopRequireDefault(require("prismjs"));Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=exports.convertMarkdown=void 0;require("prismjs/components/prism-markdown");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}var currentList,codeBeginPointer,lineMarkdowns={blockquote:!0,list:!0,title:!0,hr:!0},isLineMarkdown=function(a){var b=a.type;return!!lineMarkdowns[b]},previewMarkdowns={bold:!0,code:!0,italic:!0},canPreview=function(a){var b=a.type;return!!previewMarkdowns[b]},lists=[],setOrderedListStartWith=function(a){var b=/(\d+)\./.exec(a.content);return b&&b[1]},setCurrentList=function(a){var b=a.blockNode,c=a.isOrderedList,d=a.token;currentList={startNode:b,endNode:b,isOrderedList:c,startsWith:setOrderedListStartWith(d)}},isInvalidTitle=function(a){return"title"===a.type&&Array.isArray(a.content)&&a.content[1]&&" "!==a.content[1][0]},lineContentLength=function(a){return Array.isArray(a.content)?a.content[0].length:a.length},getTitleType=function(a){var b=5<a?5:a;return"h".concat(b)},urlRegex=/(?:(?:https?|ftp|file):\/\/|www\.|ftp\.)(?:\([-A-Z0-9+&@#/%=~_|$?!:,.]*\)|[-A-Z0-9+&@#/%=~_|$?!:,.])*(?:\([-A-Z0-9+&@#/%=~_|$?!:,.]*\)|[A-Z0-9+&@#/%=~_|$])/igm,emailRegex=/(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/igm,codeBegin=/^```[\s]?([\S]*)$/m,codeEnd=/^```$/m,markCode=function(a){var b=a.editor,c=a.blockNode,d=a.done;if(d)return void(codeBeginPointer=null);if(1===c.getTexts().size){var e=c.getFirstText();if(!codeBeginPointer&&codeBegin.test(e.text)){var f=codeBegin.exec(e.text);codeBeginPointer={node:e,language:f[1]}}else if(codeBeginPointer&&codeEnd.test(e.text)){codeEnd.exec(e.text);var g={node:e};b.moveAnchorToStartOfNode(codeBeginPointer.node).moveFocusToEndOfNode(g.node).setBlocks("plain").setMark("plain").wrapBlock({type:"code",data:{language:codeBeginPointer.language}}).deleteNode(codeBeginPointer.node).deleteNode(g.node),codeBeginPointer=null}}},replaceRegex=function(a,b){return a.replace(b,function(a){var b=a.length;return"0".repeat(b)})},hideEmail=function(a){return replaceRegex(a,emailRegex)},hideUrl=function(a){return replaceRegex(a,urlRegex)},initMarkRange=function(a){var b=function(a){var b=a.getTexts().toArray(),c=b.shift();return{texts:b,startText:c,endText:c,startOffset:0,endOffset:0,start:0}},c=b(a),d=c.texts,e=c.startText,f=c.endText,g=c.startOffset,h=c.endOffset,i=c.start;return function(a){var b=a.editor,c=a.length,j=a.mark;e=f,g=h;var k=i+c,l=e.text.length-g,m=c;for(h=g+m;l<m;)f=d.shift(),m-=l,l=f.text.length,h=m;"string"!==j&&b.moveAnchorToStartOfNode(e).moveAnchorForward(g).moveFocusToStartOfNode(f).moveFocusForward(h).addMark(j),i=k}},_convertMarkdown=function(a){var b=a.editor,c=a.node,d=a.done,e=!1;if(!d){if("block"!==c.object||"code"===c.type)return;var f="",g=!0,h=!1,j=void 0;try{for(var k,l,m=c.nodes[Symbol.iterator]();!(g=(k=m.next()).done);g=!0)l=k.value,f+=l.type?"0".repeat(l.text.length):l.text}catch(a){h=!0,j=a}finally{try{g||null==m["return"]||m["return"]()}finally{if(h)throw j}}var n=hideEmail(hideUrl(f)),o=_prismjs["default"].languages.markdown,p=_prismjs["default"].tokenize(n,o),q=initMarkRange(c),r=!0,s=!1,t=void 0;try{for(var u,v,w=p[Symbol.iterator]();!(r=(u=w.next()).done);r=!0)if(v=u.value,"string"==typeof v||isInvalidTitle(v))q({editor:b,length:v.length,mark:"string"});else if(isLineMarkdown(v)){var O=lineContentLength(v);if(q({editor:b,length:O,mark:"delete"}),"list"===v.type){// Unordered list will be one character (-, #, etc)
// Ordered list will be digit plus a period
var P=1<O;e=!0,b.setBlocks("list-item"),currentList?currentList.isOrderedList===P?currentList.endNode=c:(lists.push(currentList),setCurrentList({blockNode:c,isOrderedList:P,token:v})):setCurrentList({blockNode:c,isOrderedList:P,token:v})}else{var Q="title"===v.type?getTitleType(O):v.type;b.setBlocks({type:Q})}}else if("code"===v.type){// Non-backtick 'code' block
if(0<v.content.length&&"`"!==v.content.charAt(0))q({editor:b,length:v.length,mark:v.type});else{// Remove the first and last characters which are backticks
var R=v.content.length-2;q({editor:b,length:1,mark:"delete"}),q({editor:b,length:R,mark:v.type}),q({editor:b,length:1,mark:"delete"})}}else if("tag"!==v.type){var x=!0,y=!1,z=void 0;try{for(var A,B,C=v.content[Symbol.iterator]();!(x=(A=C.next()).done);x=!0)B=A.value,"string"==typeof B?q({editor:b,length:B.length,mark:v.type}):"punctuation"===B.type?q({editor:b,length:B.length,mark:"delete"}):q({editor:b,length:B.length,mark:v.type})}catch(a){y=!0,z=a}finally{try{x||null==C["return"]||C["return"]()}finally{if(y)throw z}}}}catch(a){s=!0,t=a}finally{try{r||null==w["return"]||w["return"]()}finally{if(s)throw t}}}if(currentList&&!e&&(lists.push(currentList),currentList=null),d){var D=!0,E=!1,F=void 0;try{for(var G,H=lists[Symbol.iterator]();!(D=(G=H.next()).done);D=!0){var I=G.value,J=I.startNode,K=I.endNode,L=I.isOrderedList,M=I.startsWith,N=L?"ordered-list":"unordered-list";b.moveAnchorToStartOfNode(J).moveFocusToEndOfNode(K).wrapBlock({type:N,data:{start:M}}),currentList=null}}catch(a){E=!0,F=a}finally{try{D||null==H["return"]||H["return"]()}finally{if(E)throw F}}lists.length=0}},convertMarkdown=function(a){var b=a.editor;if(!b.props.markdown.disabled){// Find all of the code blocks to avoid converting
// code block inner texts to markdown
var c=!0,d=!1,e=void 0;try{for(var f,g,h=b.value.document.nodes[Symbol.iterator]();!(c=(f=h.next()).done);c=!0)g=f.value,markCode({editor:b,blockNode:g})}catch(a){d=!0,e=a}finally{try{c||null==h["return"]||h["return"]()}finally{if(d)throw e}}markCode({editor:b,done:!0});var i=!0,j=!1,k=void 0;try{for(var l,m,n=b.value.document.nodes[Symbol.iterator]();!(i=(l=n.next()).done);i=!0)m=l.value,_convertMarkdown({editor:b,node:m})}catch(a){j=!0,k=a}finally{try{i||null==n["return"]||n["return"]()}finally{if(j)throw k}}_convertMarkdown({editor:b,done:!0})}};exports.convertMarkdown=convertMarkdown;var MarkDown=function(){return{decorateNode:function decorateNode(a,b,c){function d(a){return"string"==typeof a?a.length:"string"==typeof a.content?a.content.length:a.content.reduce(function(a,b){return a+d(b)},0)}var e=c()||[];if("block"!==a.object||b.props.markdown.disabled)return e;var f=[],g=hideUrl(hideEmail(a.text)),h=_prismjs["default"].languages.markdown,i=_prismjs["default"].tokenize(g,h),j=function(a){var b=a.getTexts().toArray(),c=b.shift();return{texts:b,startText:c,endText:c,startOffset:0,endOffset:0,start:0}},k=j(a),l=k.texts,m=k.startText,n=k.endText,o=k.startOffset,p=k.endOffset,q=k.start,r=!0,s=!1,t=void 0;try{for(var u,v,w=i[Symbol.iterator]();!(r=(u=w.next()).done);r=!0){v=u.value,m=n,o=p;var x=canPreview(v)?d(v):v.length,y=q+x,z=m.text.length-o,A=x;for(p=o+A;z<A;)n=l.shift(),A-=z,z=n.text.length,p=A;if("string"!=typeof v&&canPreview(v)){var B={anchor:{key:m.key,offset:o},focus:{key:n.key,offset:p},mark:{type:v.type}};f.push(B)}q=y}}catch(a){s=!0,t=a}finally{try{r||null==w["return"]||w["return"]()}finally{if(s)throw t}}return[].concat(_toConsumableArray(e),f)},commands:{setMark:function setMark(a,b){a.value.document.getMarksAtRange(a.value.selection).forEach(function(b){a.removeMark(b.type)}),a.toggleMark(b)},deleteNode:function deleteNode(a,b){a.moveAnchorToStartOfNode(b),a.moveFocusToEndOfNode(b),a["delete"]()}}}},_default=MarkDown;exports["default"]=_default;