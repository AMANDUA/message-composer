"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=_default;var _react=_interopRequireDefault(require("react")),_tinyEmitter=require("tiny-emitter"),_types=require("./types"),_utils=require("./utils"),_suggestions=_interopRequireDefault(require("./suggestions"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _extends(){return _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_extends.apply(this,arguments)}var renderMentionContext=function(a){return function(b){var c=b.ref;return _react["default"].createElement("span",_extends({},a.attributes,{ref:c,className:"mention-context"}),a.children)}},schema={inlines:_defineProperty({},_types.USER_MENTION_NODE_TYPE,{// It's important that we mark the mentions as void nodes so that users
// can't edit the text of the mention.
isVoid:!0})},defaultMentionProps={filter:function filter(){return Promise.resolve([])},renderSuggestion:function renderSuggestion(){return null},renderInsert:function renderInsert(){return null},getDisplay:function getDisplay(){return""}};function _default(){var a,b=function(b){if(a)try{return b.setDecorations(a).value}finally{a=null}return null};return{markMention:b,Plugin:function Plugin(){var b,c=new _tinyEmitter.TinyEmitter;c.on("SEARCH",function(a){b=a});var d={open:!1},e=function(a){var b=a.open;d.open=b},f=function(){return d.open},g=null;return{onKeyDown:function onKeyDown(a,b,d){if(f())switch(a.key){case"ArrowDown":return a.preventDefault(),c.emit("MOVE_DOWN"),!0;case"ArrowUp":return a.preventDefault(),c.emit("MOVE_UP"),!0;case"Enter":case"Tab":return a.preventDefault(),c.emit("SELECT"),!0;case"Escape":return a.preventDefault(),c.emit("DISABLE"),!0;default:return d();}return d()},onChange:function onChange(b,d){var e=(0,_utils.getInput)(b.value),f=_slicedToArray(e,2),h=f[0],i=f[1];if(i!==g){g=i,(0,_utils.hasValidAncestors)(b.value)&&c.emit("SEARCH",i);var j=b.value.selection,k=b.value.decorations.filter(function(a){return a.mark.type!==_types.CONTEXT_MARK_TYPE});if(null!==i&&(0,_utils.hasValidAncestors)(b.value)){var l=j.start.offset-i.length;k=k.push({anchor:{key:j.start.key,offset:l-h.length},focus:{key:j.start.key,offset:l},mark:{type:_types.CONTEXT_MARK_TYPE}})}a=k}d()},onBlur:function onBlur(a,b,c){// Remove 'mentions' when losing focus
b.clearSuggestionsMarker(),c()},onFocus:function onFocus(a,b,c){b.clearSuggestionsLastInput(),c()},renderMark:function renderMark(a,d,f){return a.mark.type===_types.CONTEXT_MARK_TYPE?_react["default"].createElement(_suggestions["default"],{emitter:c,setFlags:e,initialQuery:b,mentions:d.props.mentions||defaultMentionProps,editor:d},renderMentionContext(a)):f()},renderNode:function renderNode(a,b,c){var d=a.attributes,e=a.node;return e.type===_types.USER_MENTION_NODE_TYPE?_react["default"].createElement("span",d,b.props.mentions.renderInsert(e.data.toJS())):c()},commands:{clearSuggestionsMarker:function clearSuggestionsMarker(b){a=b.value.decorations.filter(function(a){return a.mark.type!==_types.CONTEXT_MARK_TYPE})},clearSuggestionsLastInput:function clearSuggestionsLastInput(){g=null}},schema:schema}}}}